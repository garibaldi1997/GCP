<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encuesta de Salud Laboral</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo personalizado para la aplicación */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 900px;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .radio-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            transition: background-color 0.2s;
        }
        .radio-label:hover {
            background-color: #e5e7eb;
        }
        input[type="radio"]:checked + span {
            background-color: #2563eb;
            color: #ffffff;
        }
        input[type="radio"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #2563eb;
            color: #fff;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 1000;
            transition: transform 0.3s ease-in-out;
            transform: translateY(-100vh);
        }
        .message-box.show {
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

<div class="message-box" id="message-box"></div>

<div class="container mx-auto p-8 bg-white rounded-3xl shadow-2xl">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">Análisis de Salud Laboral</h1>
    
    <div class="card p-8 mb-8">
        <h2 class="text-xl font-semibold mb-6 text-gray-700">Información del Asociado</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div>
                <label for="empresa" class="block text-sm font-medium text-gray-600">Empresa</label>
                <input type="text" id="empresa" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
            </div>
            <div>
                <label for="asociado" class="block text-sm font-medium text-gray-600">Asociado</label>
                <input type="text" id="asociado" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
            </div>
            <div>
                <label for="edad" class="block text-sm font-medium text-gray-600">Edad</label>
                <input type="number" id="edad" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
            </div>
            <div>
                <label for="genero" class="block text-sm font-medium text-gray-600">Género</label>
                <select id="genero" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                    <option value="">Seleccionar</option>
                    <option value="Masculino">Masculino</option>
                    <option value="Femenino">Femenino</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>
            <div>
                <label for="peso" class="block text-sm font-medium text-gray-600">Peso (kg)</label>
                <input type="number" id="peso" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
            </div>
            <div>
                <label for="talla" class="block text-sm font-medium text-gray-600">Talla (metros)</label>
                <input type="number" id="talla" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50" step="0.01">
            </div>
            <div>
                <label for="puesto" class="block text-sm font-medium text-gray-600">Puesto de trabajo</label>
                <input type="text" id="puesto" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
            </div>
            <div>
                <label for="area" class="block text-sm font-medium text-gray-600">Área de trabajo</label>
                <input type="text" id="area" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
            </div>
        </div>
    </div>
    
    <div class="card p-8 mb-8">
        <h2 class="text-xl font-semibold mb-6 text-gray-700">Encuesta 1: Molestias Músculo-Esqueléticas</h2>
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                        <th scope="col" class="py-3 px-6">Zona Corporal</th>
                        <th scope="col" class="py-3 px-6">A: ¿Dolor/Molestias?</th>
                        <th scope="col" class="py-3 px-6">B: ¿Persisten fuera del trabajo?</th>
                        <th scope="col" class="py-3 px-6">C: ¿Han impedido actividad laboral?</th>
                        <th scope="col" class="py-3 px-6">D: ¿Ha acudido a médico?</th>
                        <th scope="col" class="py-3 px-6">E: ¿Ha perdido días de trabajo?</th>
                    </tr>
                </thead>
                <tbody id="encuesta1-table-body">
                    </tbody>
            </table>
        </div>
    </div>

    <div class="card p-8 mb-8">
        <h2 class="text-xl font-semibold mb-6 text-gray-700">Encuesta 2: Riesgo por Bipedestación</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-gray-50 p-6 rounded-xl">
                <h3 class="font-medium text-gray-700 mb-4">Tiempo que la persona trabajadora permanece de pie</h3>
                <div class="flex flex-col space-y-2">
                    <label class="radio-label">
                        <input type="radio" name="bipedestacion" value="1" class="hidden">
                        <span class="ml-2">≤ 30 minutos (1 punto)</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="bipedestacion" value="2" class="hidden">
                        <span class="ml-2">> 30 min y ≤ 1 hora (2 puntos)</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="bipedestacion" value="3" class="hidden">
                        <span class="ml-2">> 1 hora (3 puntos)</span>
                    </label>
                </div>
            </div>

            <div class="bg-gray-50 p-6 rounded-xl">
                <h3 class="font-medium text-gray-700 mb-4">Posibilidad de cambiar de postura</h3>
                <div class="flex flex-col space-y-2">
                    <label class="radio-label">
                        <input type="radio" name="postura" value="1" class="hidden">
                        <span class="ml-2">Sí, con frecuencia (1 punto)</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="postura" value="2" class="hidden">
                        <span class="ml-2">Algunas veces (2 puntos)</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="postura" value="3" class="hidden">
                        <span class="ml-2">No puede cambiar de postura (3 puntos)</span>
                    </label>
                </div>
            </div>

            <div class="bg-gray-50 p-6 rounded-xl">
                <h3 class="font-medium text-gray-700 mb-4">Tipo de superficie de trabajo</h3>
                <div class="flex flex-col space-y-2">
                    <label class="radio-label">
                        <input type="radio" name="superficie" value="1" class="hidden">
                        <span class="ml-2">Piso con recubrimiento blando (1 punto)</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="superficie" value="2" class="hidden">
                        <span class="ml-2">Piso firme pero no duro (2 puntos)</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="superficie" value="3" class="hidden">
                        <span class="ml-2">Piso duro sin recubrimiento (3 puntos)</span>
                    </label>
                </div>
            </div>

            <div class="bg-gray-50 p-6 rounded-xl">
                <h3 class="font-medium text-gray-700 mb-4">Características del calzado utilizado</h3>
                <div class="flex flex-col space-y-2">
                    <label class="radio-label">
                        <input type="radio" name="calzado" value="1" class="hidden">
                        <span class="ml-2">Ergonómico (1 punto)</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="calzado" value="2" class="hidden">
                        <span class="ml-2">Aceptable (2 puntos)</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="calzado" value="3" class="hidden">
                        <span class="ml-2">Inadecuado (3 puntos)</span>
                    </label>
                </div>
            </div>

            <div class="bg-gray-50 p-6 rounded-xl">
                <h3 class="font-medium text-gray-700 mb-4">Espacio disponible para moverse</h3>
                <div class="flex flex-col space-y-2">
                    <label class="radio-label">
                        <input type="radio" name="espacio" value="1" class="hidden">
                        <span class="ml-2">Amplio (1 punto)</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="espacio" value="2" class="hidden">
                        <span class="ml-2">Limitado (2 puntos)</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="espacio" value="3" class="hidden">
                        <span class="ml-2">Muy reducido (3 puntos)</span>
                    </label>
                </div>
            </div>

            <div class="bg-gray-50 p-6 rounded-xl">
                <h3 class="font-medium text-gray-700 mb-4">Malestares reportados</h3>
                <div class="flex flex-col space-y-2">
                    <label class="radio-label">
                        <input type="radio" name="malestares" value="1" class="hidden">
                        <span class="ml-2">Ninguno (1 punto)</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="malestares" value="2" class="hidden">
                        <span class="ml-2">Fatiga, dolor o pesadez ocasional (2 puntos)</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="malestares" value="3" class="hidden">
                        <span class="ml-2">Dolor lumbar, hinchazón, calambres (3 puntos)</span>
                    </label>
                </div>
            </div>

            <div class="bg-gray-50 p-6 rounded-xl">
                <h3 class="font-medium text-gray-700 mb-4">Pausas</h3>
                <div class="flex flex-col space-y-2">
                    <label class="radio-label">
                        <input type="radio" name="pausas" value="1" class="hidden">
                        <span class="ml-2">Pausas planeadas (1 punto)</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="pausas" value="2" class="hidden">
                        <span class="ml-2">Permite algunas pausas no programadas (2 puntos)</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="pausas" value="3" class="hidden">
                        <span class="ml-2">No tiene pausas (3 puntos)</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <div class="flex justify-center space-x-4 mb-8">
        <button id="save-btn" class="px-8 py-3 font-semibold text-white bg-purple-600 rounded-full shadow-lg hover:bg-purple-700 focus:outline-none focus:ring-4 focus:ring-purple-500 focus:ring-opacity-50 transition transform hover:scale-105">
            Guardar Registro 💾
        </button>
        <button id="export-excel-btn" class="px-8 py-3 font-semibold text-white bg-gray-600 rounded-full shadow-lg hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-500 focus:ring-opacity-50 transition transform hover:scale-105" disabled>
            Exportar a Excel 📊
        </button>
    </div>

    <div id="results" class="hidden">
        <div class="card p-8 mb-8">
            <h2 class="text-xl font-semibold mb-6 text-gray-700">Análisis de Resultados</h2>
            
            <div class="mb-8 p-6 bg-gray-50 rounded-xl">
                <h3 class="font-medium text-gray-700 mb-4">Resumen de Puntuaciones y Datos</h3>
                <p><strong>Puntuación Total Encuesta 1:</strong> <span id="total-score-1" class="font-bold"></span></p>
                <p><strong>IMC:</strong> <span id="imc-value" class="font-bold"></span> - <span id="imc-classification" class="font-bold"></span></p>
                <p><strong>Nivel de Riesgo (Encuesta 2):</strong> <span id="risk-level" class="font-bold"></span></p>
            </div>
            
            <div class="mb-8">
                <h3 class="font-medium text-gray-700 mb-4">Puntuaciones de Molestias por Zona Corporal</h3>
                <div id="encuesta1-scores" class="bg-gray-50 p-6 rounded-xl text-gray-800 leading-relaxed whitespace-pre-wrap">
                    </div>
            </div>

            <div id="analysis-section" class="hidden">
                <h3 class="font-medium text-gray-700 mb-4">Análisis Generado por IA</h3>
                <div id="analysis-text" class="bg-gray-50 p-6 rounded-xl text-gray-800 leading-relaxed whitespace-pre-wrap">
                    </div>
                <div class="mt-4 flex justify-center">
                    <button id="generate-analysis-btn" class="px-6 py-2 font-semibold text-white bg-purple-600 rounded-full shadow-lg hover:bg-purple-700 focus:outline-none focus:ring-4 focus:ring-purple-500 focus:ring-opacity-50 transition transform hover:scale-105">
                        Generar Análisis ✨
                    </button>
                    <button id="read-analysis-btn" class="ml-4 px-6 py-2 font-semibold text-white bg-green-600 rounded-full shadow-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50 transition transform hover:scale-105" disabled>
                        Leer Análisis 🔊
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card p-8 mt-8 hidden" id="saved-records-section">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold text-gray-700">Registros Guardados</h2>
        </div>
        <div id="records-list" class="flex flex-col space-y-4">
            </div>
    </div>
</div>

<script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
    // Zonas corporales para la Encuesta 1
    const zonasCorporales = [
        "Cuello", "Espalda dorsal", "Espalda lumbar", "Hombros y brazos",
        "Codos y antebrazos", "Muñecas y manos", "Caderas, nalgas, muslos",
        "Rodillas y piernas", "Tobillos y pies"
    ];

    // Apartados de la Encuesta 2
    const encuesta2Questions = ['bipedestacion', 'postura', 'superficie', 'calzado', 'espacio', 'malestares', 'pausas'];

    // Helper para mostrar mensajes temporales
    function showMessage(message) {
        const messageBox = document.getElementById('message-box');
        if (messageBox) { // Asegurarse de que el elemento existe
            messageBox.textContent = message;
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000);
        }
    }

    // Carga los registros desde localStorage
    function getSavedRecords() {
        const records = localStorage.getItem('encuestas_salud_records');
        return records ? JSON.parse(records) : [];
    }

    // Guarda los registros en localStorage
    function saveRecords(records) {
        localStorage.setItem('encuestas_salud_records', JSON.stringify(records));
    }
    
    // Muestra los registros guardados en la página
    function displaySavedRecords() {
        const recordsListDiv = document.getElementById('records-list');
        const savedRecordsSection = document.getElementById('saved-records-section');
        if (!recordsListDiv || !savedRecordsSection) return;
        
        const records = getSavedRecords();
        savedRecordsSection.classList.remove('hidden');

        if (records.length === 0) {
            recordsListDiv.innerHTML = '<p class="text-gray-500">No hay registros guardados.</p>';
            const exportBtn = document.getElementById('export-excel-btn');
            if (exportBtn) exportBtn.disabled = true;
        } else {
            recordsListDiv.innerHTML = '';
            const exportBtn = document.getElementById('export-excel-btn');
            if (exportBtn) exportBtn.disabled = false;

            records.forEach((record, index) => {
                const recordElement = document.createElement('div');
                recordElement.className = 'p-4 border border-gray-200 rounded-lg shadow-sm bg-white flex justify-between items-center';
                recordElement.setAttribute('data-index', index);

                const asociadoNombre = record.asociadoData?.asociado || 'N/A';
                const puesto = record.asociadoData?.puesto || 'N/A';
                const area = record.asociadoData?.area || 'N/A';
                const riesgo = record.riskLevel || 'N/A';
                const fecha = new Date(record.timestamp).toLocaleString();
                
                recordElement.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-900">Asociado: ${asociadoNombre}</p>
                        <p class="text-sm text-gray-600">Puesto: ${puesto}, Área: ${area}</p>
                        <p class="text-sm text-gray-600">Fecha de registro: ${fecha}</p>
                        <p class="text-sm text-gray-600 mt-2">Nivel de Riesgo (Bipedestación): <span class="font-bold">${riesgo}</span></p>
                    </div>
                    <div>
                        <button data-index="${index}" class="edit-btn px-4 py-2 text-sm font-semibold text-blue-600 bg-blue-100 rounded-full hover:bg-blue-200 mr-2">
                            Editar
                        </button>
                        <button data-index="${index}" class="delete-btn px-4 py-2 text-sm font-semibold text-red-600 bg-red-100 rounded-full hover:bg-red-200">
                            Eliminar
                        </button>
                    </div>
                `;
                recordsListDiv.appendChild(recordElement);
            });

            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = e.target.dataset.index;
                    loadRecordForEditing(index);
                });
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = e.target.dataset.index;
                    deleteRecord(index);
                });
            });
        }
    }

    // Limpia el formulario
    function resetForm() {
        document.getElementById('empresa').value = '';
        document.getElementById('asociado').value = '';
        document.getElementById('edad').value = '';
        document.getElementById('genero').value = '';
        document.getElementById('peso').value = '';
        document.getElementById('talla').value = '';
        document.getElementById('puesto').value = '';
        document.getElementById('area').value = '';

        // Reinicia los radios de la Encuesta 1
        zonasCorporales.forEach((_, index) => {
            const radioA_no = document.querySelector(`input[name="qA-row${index}"][value="no"]`);
            if (radioA_no) {
                radioA_no.checked = true;
            }
            ['B', 'C', 'D', 'E'].forEach(q => {
                const questionContainer = document.querySelector(`input[name="q${q}-row${index}"]`)?.closest('td');
                if (questionContainer) {
                    questionContainer.style.pointerEvents = 'auto';
                    questionContainer.style.opacity = '1';
                    questionContainer.querySelectorAll('input').forEach(radio => radio.disabled = false);
                    document.querySelector(`input[name="q${q}-row${index}"][value="no"]`).checked = true;
                }
            });
        });

        // Reinicia los radios de la Encuesta 2
        encuesta2Questions.forEach(qName => {
            document.querySelectorAll(`input[name="${qName}"]`).forEach(radio => radio.checked = false);
        });

        document.getElementById('results').classList.add('hidden');
        const saveBtn = document.getElementById('save-btn');
        if (saveBtn) {
            saveBtn.textContent = 'Guardar Registro 💾';
        }
    }
    
    // Calcula el IMC y su clasificación
    function calculateIMC(peso, talla) {
        if (!peso || !talla || talla === 0) {
            return { value: 'N/A', classification: 'N/A' };
        }
        const imc = peso / (talla * talla);
        let classification = '';
        if (imc < 18.5) {
            classification = 'Bajo Peso';
        } else if (imc >= 18.5 && imc < 25) {
            classification = 'Peso Normal';
        } else if (imc >= 25 && imc < 30) {
            classification = 'Sobrepeso';
        } else if (imc >= 30 && imc < 35) {
            classification = 'Obesidad Grado 1';
        } else if (imc >= 35 && imc < 40) {
            classification = 'Obesidad Grado 2';
        } else {
            classification = 'Obesidad Grado 3';
        }
        return { value: imc.toFixed(2), classification };
    }
    
    function normalizeString(str) {
        if (typeof str !== 'string') return 'N/A';
        return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
    }
    
    // Carga un registro para editar
    function loadRecordForEditing(index) {
        const records = getSavedRecords();
        const data = records[index];

        if (!data) {
            showMessage("Registro no encontrado.");
            return;
        }
        
        document.getElementById('empresa').value = data.asociadoData?.empresa || '';
        document.getElementById('asociado').value = data.asociadoData?.asociado || '';
        document.getElementById('edad').value = data.asociadoData?.edad || '';
        document.getElementById('genero').value = data.asociadoData?.genero || '';
        document.getElementById('peso').value = data.asociadoData?.peso || '';
        document.getElementById('talla').value = data.asociadoData?.talla || '';
        document.getElementById('puesto').value = data.asociadoData?.puesto || '';
        document.getElementById('area').value = data.asociadoData?.area || '';

        const encuesta1Data = data.encuesta1Scores || [];
        zonasCorporales.forEach((_, i) => {
            const score = encuesta1Data[i] || 0;
            const row = document.querySelector(`.zona-${i}`);
            
            if (row) {
                if (score === 0) {
                    const radioA_no = row.querySelector(`input[name="qA-row${i}"][value="no"]`);
                    if(radioA_no) radioA_no.checked = true;
                    const relatedQuestions = ['B', 'C', 'D', 'E'];
                    relatedQuestions.forEach(q => {
                        const questionContainer = row.querySelector(`input[name="q${q}-row${i}"]`)?.closest('td');
                        if(questionContainer) {
                            questionContainer.style.pointerEvents = 'none';
                            questionContainer.style.opacity = '0.5';
                            questionContainer.querySelectorAll('input').forEach(radio => {
                                radio.disabled = true;
                                if (radio.value === 'no') radio.checked = true;
                            });
                        }
                    });
                } else {
                    const radioA_si = row.querySelector(`input[name="qA-row${i}"][value="si"]`);
                    if(radioA_si) radioA_si.checked = true;
                    const relatedQuestions = ['B', 'C', 'D', 'E'];
                    relatedQuestions.forEach(q => {
                        const questionContainer = row.querySelector(`input[name="q${q}-row${i}"]`)?.closest('td');
                        if(questionContainer) {
                            questionContainer.style.pointerEvents = 'auto';
                            questionContainer.style.opacity = '1';
                            questionContainer.querySelectorAll('input').forEach(radio => radio.disabled = false);
                        }
                    });
                    
                    let scoreCount = 0;
                    const questions = ['A', 'B', 'C', 'D', 'E'];
                    for (let j = 0; j < questions.length; j++) {
                        const radioSi = row.querySelector(`input[name="q${questions[j]}-row${i}"][value="si"]`);
                        const radioNo = row.querySelector(`input[name="q${questions[j]}-row${i}"][value="no"]`);
                        if (scoreCount < score) {
                            if(radioSi) radioSi.checked = true;
                            if(radioNo) radioNo.checked = false;
                            scoreCount++;
                        } else {
                            if(radioSi) radioSi.checked = false;
                            if(radioNo) radioNo.checked = true;
                        }
                    }
                }
            }
        });

        const encuesta2Selections = data.encuesta2Selections || {};
        encuesta2Questions.forEach(qName => {
            const selectedValue = encuesta2Selections[qName];
            if (selectedValue) {
                const radio = document.querySelector(`input[name="${qName}"][value="${selectedValue}"]`);
                if (radio) radio.checked = true;
            }
        });

        const saveBtn = document.getElementById('save-btn');
        if (saveBtn) saveBtn.textContent = 'Guardar Cambios';
        saveBtn.dataset.editingIndex = index;
        showMessage(`Registro de ${data.asociadoData?.asociado || 'N/A'} cargado para editar.`);
    }

    // Eliminar un registro
    function deleteRecord(index) {
        const records = getSavedRecords();
        records.splice(index, 1);
        saveRecords(records);
        showMessage("Registro eliminado exitosamente.");
        displaySavedRecords();
    }
    
    // Función para recolectar todos los datos del formulario
    function collectFormData() {
        const data = {};
        
        data.asociadoData = {
            empresa: document.getElementById('empresa').value,
            asociado: document.getElementById('asociado').value,
            edad: document.getElementById('edad').value,
            genero: document.getElementById('genero').value,
            peso: document.getElementById('peso').value,
            talla: document.getElementById('talla').value,
            puesto: document.getElementById('puesto').value,
            area: document.getElementById('area').value,
        };

        data.encuesta1Scores = zonasCorporales.map((_, index) => {
            let score = 0;
            const radiosA = document.querySelector(`input[name="qA-row${index}"][value="si"]`);
            if (radiosA && radiosA.checked) {
                score++;
                ['B', 'C', 'D', 'E'].forEach(q => {
                    const radio = document.querySelector(`input[name="q${q}-row${index}"]:checked`);
                    if (radio && radio.value === 'si') {
                        score++;
                    }
                });
            }
            return score;
        });
        data.totalScore1 = data.encuesta1Scores.reduce((sum, score) => sum + score, 0);

        data.encuesta2Selections = {};
        data.totalScore2 = 0;
        encuesta2Questions.forEach(qName => {
            const selected = document.querySelector(`input[name="${qName}"]:checked`);
            if (selected) {
                const points = parseInt(selected.value, 10);
                data.totalScore2 += points;
                data.encuesta2Selections[qName] = points;
            }
        });
        
        if (data.totalScore2 <= 7) {
            data.riskLevel = "Nivel de riesgo: BAJO";
        } else if (data.totalScore2 >= 8 && data.totalScore2 <= 14) {
            data.riskLevel = "Nivel de riesgo: MEDIO";
        } else {
            data.riskLevel = "Nivel de riesgo: ALTO";
        }
        
        const peso = parseFloat(data.asociadoData.peso);
        const talla = parseFloat(data.asociadoData.talla);
        const imcResult = calculateIMC(peso, talla);
        data.imcValue = imcResult.value;
        data.imcClassification = imcResult.classification;
        
        data.timestamp = new Date().toISOString();
        
        return data;
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        const tableBody = document.getElementById('encuesta1-table-body');
        if (tableBody) {
            zonasCorporales.forEach((zona, index) => {
                const row = document.createElement('tr');
                row.className = `bg-white border-b hover:bg-gray-50 zona-${index}`;
                row.innerHTML = `
                    <th scope="row" class="py-4 px-6 font-medium text-gray-900 whitespace-nowrap">${zona}</th>
                    ${['A', 'B', 'C', 'D', 'E'].map(q => `
                        <td class="py-4 px-6">
                            <div class="flex items-center space-x-2">
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="radio" name="q${q}-row${index}" value="si" class="hidden">
                                    <span class="radio-label">Sí</span>
                                </label>
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="radio" name="q${q}-row${index}" value="no" class="hidden" checked>
                                    <span class="radio-label">No</span>
                                </label>
                            </div>
                        </td>
                    `).join('')}
                `;
                tableBody.appendChild(row);
            });
        }
        
        document.querySelectorAll('input[name^="qA-row"]').forEach((input, index) => {
            input.addEventListener('change', (event) => {
                const rowIndex = index;
                const row = document.querySelector(`.zona-${rowIndex}`);
                if (!row) return;

                const isNo = event.target.value === 'no';
                const relatedQuestions = ['B', 'C', 'D', 'E'];
                relatedQuestions.forEach(q => {
                    const questionContainer = row.querySelector(`input[name="q${q}-row${rowIndex}"]`)?.closest('td');
                    if (questionContainer) {
                        questionContainer.style.pointerEvents = isNo ? 'none' : 'auto';
                        questionContainer.style.opacity = isNo ? '0.5' : '1';
                        questionContainer.querySelectorAll('input').forEach(radio => {
                            radio.disabled = isNo;
                            if (isNo) {
                                if (radio.value === 'no') {
                                    radio.checked = true;
                                }
                            }
                        });
                    }
                });
            });
        });
        
        const saveBtn = document.getElementById('save-btn');
        if (saveBtn) {
            saveBtn.addEventListener('click', () => {
                const data = collectFormData();

                if (!data.asociadoData.asociado || !data.asociadoData.puesto || !data.asociadoData.area || !data.asociadoData.genero || Object.keys(data.encuesta2Selections).length !== 7 || !data.asociadoData.peso || !data.asociadoData.talla) {
                    showMessage("Por favor, completa toda la información requerida.");
                    return;
                }
                
                const records = getSavedRecords();
                const editingIndex = saveBtn.dataset.editingIndex;

                if (editingIndex !== undefined && records[editingIndex]) {
                    records[editingIndex] = data;
                    showMessage("Registro actualizado exitosamente.");
                } else {
                    records.push(data);
                    showMessage("Registro guardado exitosamente.");
                }
                
                saveRecords(records);
                resetForm();
                displaySavedRecords();
            });
        }
        
        const exportExcelBtn = document.getElementById('export-excel-btn');
        if (exportExcelBtn) {
            exportExcelBtn.addEventListener('click', () => {
                const allEntries = getSavedRecords();

                if (allEntries.length === 0) {
                    showMessage("No hay registros para exportar. Guarda algunos registros primero.");
                    return;
                }

                showMessage("Cargando datos para exportar...");

                const registrosData = [];
                const registrosHeaders = ["Fecha", "Empresa", "Asociado", "Edad", "Género", "Peso (kg)", "Talla (m)", "Puesto", "Área",
                    "IMC", "Clasificación IMC",
                    "Puntuación Cuello", "Puntuación Espalda dorsal", "Puntuación Espalda lumbar", "Puntuación Hombros y brazos",
                    "Puntuación Codos y antebrazos", "Puntuación Muñecas y manos", "Puntuación Caderas, nalgas, muslos",
                    "Puntuación Rodillas y piernas", "Puntuación Tobillos y pies",
                    "Puntuación Total Encuesta 1", "Total Puntos Encuesta 2", "Nivel de Riesgo",
                    "Puntos Bipedestación", "Puntos Posibilidad de cambiar de postura", "Puntos Tipo de superficie de trabajo",
                    "Puntos Características del calzado", "Puntos Espacio para moverse", "Puntos Malestares reportados", "Puntos Pausas",
                ];
                registrosData.push(registrosHeaders);
                
                allEntries.forEach(entry => {
                    const row = [
                        new Date(entry.timestamp).toLocaleString(),
                        entry.asociadoData?.empresa || '',
                        entry.asociadoData?.asociado || '',
                        entry.asociadoData?.edad || '',
                        entry.asociadoData?.genero || '',
                        entry.asociadoData?.peso || '',
                        entry.asociadoData?.talla || '',
                        entry.asociadoData?.puesto || '',
                        entry.asociadoData?.area || '',
                        entry.imcValue || '',
                        entry.imcClassification || '',
                        entry.totalScore1 || '',
                        ...(entry.encuesta1Scores || []).map(s => s || ''),
                        entry.totalScore2 || '',
                        entry.riskLevel || '',
                        entry.encuesta2Selections?.bipedestacion || '',
                        entry.encuesta2Selections?.postura || '',
                        entry.encuesta2Selections?.superficie || '',
                        entry.encuesta2Selections?.calzado || '',
                        entry.encuesta2Selections?.espacio || '',
                        entry.encuesta2Selections?.malestares || '',
                        entry.encuesta2Selections?.pausas || '',
                    ];
                    registrosData.push(row);
                });
                
                const analysisData = [];
                analysisData.push(["Análisis General de Encuestas"]);
                analysisData.push([]);
                
                const totalEntries = allEntries.length;
                
                analysisData.push(["Análisis Demográfico y de Riesgo"]);
                analysisData.push(["Total de Registros", totalEntries]);
                analysisData.push([]);
                
                const generoCounts = { 'Masculino': 0, 'Femenino': 0, 'Otro': 0 };
                const generoRiskCounts = { 'Masculino': { alto: 0, total: 0 }, 'Femenino': { alto: 0, total: 0 }, 'Otro': { alto: 0, total: 0 } };
                const generoObesityCounts = { 'Masculino': { total: 0, obesidad: 0 }, 'Femenino': { total: 0, obesidad: 0 }, 'Otro': { total: 0, obesidad: 0 } };

                allEntries.forEach(entry => {
                    const genero = entry.asociadoData?.genero || 'N/A';
                    if (generoCounts[genero] !== undefined) { generoCounts[genero]++; }
                    
                    if (generoRiskCounts[genero] !== undefined) {
                        generoRiskCounts[genero].total++;
                        if (entry.riskLevel === 'Nivel de riesgo: ALTO') { generoRiskCounts[genero].alto++; }
                    }
                    if (generoObesityCounts[genero] !== undefined) {
                        generoObesityCounts[genero].total++;
                        if (entry.imcClassification && entry.imcClassification.includes('Obesidad')) { generoObesityCounts[genero].obesidad++; }
                    }
                });
                
                analysisData.push(["Género", "Total", "% del Total", "Riesgo Alto", "% Riesgo Alto", "Obesidad", "% Obesidad"]);
                for (const genero in generoCounts) {
                    if (genero !== 'N/A') {
                        const total = generoCounts[genero];
                        const totalPercentage = totalEntries > 0 ? ((total / totalEntries) * 100).toFixed(2) : 0;
                        const alto = generoRiskCounts[genero]?.alto || 0;
                        const altoPercentage = total > 0 ? ((alto / total) * 100).toFixed(2) : 0;
                        const obesidad = generoObesityCounts[genero]?.obesidad || 0;
                        const obesidadPercentage = total > 0 ? ((obesidad / total) * 100).toFixed(2) : 0;
                        analysisData.push([genero, total, `${totalPercentage}%`, alto, `${altoPercentage}%`, obesidad, `${obesidadPercentage}%`]);
                    }
                }
                analysisData.push([]);

                const edadRiskCounts = {};
                allEntries.forEach(entry => {
                    const edad = parseInt(entry.asociadoData?.edad, 10);
                    if (!isNaN(edad)) {
                        const edadRange = `${Math.floor(edad / 10) * 10}-${Math.floor(edad / 10) * 10 + 9} años`;
                        if (!edadRiskCounts[edadRange]) { edadRiskCounts[edadRange] = { total: 0, alto: 0 }; }
                        edadRiskCounts[edadRange].total++;
                        if (entry.riskLevel === 'Nivel de riesgo: ALTO') { edadRiskCounts[edadRange].alto++; }
                    }
                });
                const sortedEdadRanges = Object.keys(edadRiskCounts).sort((a, b) => parseInt(a.split('-')[0]) - parseInt(b.split('-')[0]));
                analysisData.push(["Análisis de Riesgo por Rango de Edad"]);
                analysisData.push(["Rango de Edad", "Total", "% del Total", "Riesgo Alto", "% Riesgo Alto"]);
                sortedEdadRanges.forEach(range => {
                    const count = edadRiskCounts[range].total;
                    const highRiskCount = edadRiskCounts[range].alto;
                    const totalPercentage = totalEntries > 0 ? ((count / totalEntries) * 100).toFixed(2) : 0;
                    const highRiskPercentage = count > 0 ? ((highRiskCount / count) * 100).toFixed(2) : 0;
                    analysisData.push([range, count, `${totalPercentage}%`, highRiskCount, `${highRiskPercentage}%`]);
                });
                analysisData.push([]);

                const imcCountsFinal = {};
                const imcCategories = ['Bajo Peso', 'Peso Normal', 'Sobrepeso', 'Obesidad Grado 1', 'Obesidad Grado 2', 'Obesidad Grado 3'];
                imcCategories.forEach(cat => imcCountsFinal[cat] = 0);
                allEntries.forEach(entry => {
                    const cat = entry.imcClassification || 'N/A';
                    if (imcCountsFinal[cat] !== undefined) { imcCountsFinal[cat]++; }
                });
                analysisData.push(["Clasificación IMC", "Total", "% del Total"]);
                for (const cat in imcCountsFinal) {
                    const percentage = totalEntries > 0 ? ((imcCountsFinal[cat] / totalEntries) * 100).toFixed(2) : 0;
                    analysisData.push([cat, imcCountsFinal[cat], `${percentage}%`]);
                }
                analysisData.push([]);
                
                analysisData.push(["Análisis de la Encuesta 1 (Molestias)"]);
                analysisData.push(["Zona Corporal", "Puntaje Promedio", "Pregunta A (Dolor/Molestias)", "Pregunta B (Persisten fuera)", "Pregunta C (Impiden laborar)", "Pregunta D (Médico)", "Pregunta E (Días perdidos)"]);
                
                const encuesta1QCounts = {};
                const preguntasQ1 = ['A', 'B', 'C', 'D', 'E'];
                zonasCorporales.forEach(zona => {
                    encuesta1QCounts[zona] = { A: 0, B: 0, C: 0, D: 0, E: 0, total: 0 };
                });

                allEntries.forEach(entry => {
                    (entry.encuesta1Scores || []).forEach((score, index) => {
                        const zona = zonasCorporales[index];
                        if (!encuesta1QCounts[zona]) {
                            encuesta1QCounts[zona] = { A: 0, B: 0, C: 0, D: 0, E: 0, total: 0 };
                        }
                        encuesta1QCounts[zona].total += score;
                        if(score >= 1) encuesta1QCounts[zona]['A']++;
                        if(score >= 2) encuesta1QCounts[zona]['B']++;
                        if(score >= 3) encuesta1QCounts[zona]['C']++;
                        if(score >= 4) encuesta1QCounts[zona]['D']++;
                        if(score >= 5) encuesta1QCounts[zona]['E']++;
                    });
                });
                
                zonasCorporales.forEach(zona => {
                    const avgScore = totalEntries > 0 ? (encuesta1QCounts[zona].total / totalEntries).toFixed(2) : 0;
                    analysisData.push([
                        zona,
                        avgScore,
                        `${encuesta1QCounts[zona].A} (${totalEntries > 0 ? ((encuesta1QCounts[zona].A / totalEntries) * 100).toFixed(2) : 0}%)`,
                        `${encuesta1QCounts[zona].B} (${totalEntries > 0 ? ((encuesta1QCounts[zona].B / totalEntries) * 100).toFixed(2) : 0}%)`,
                        `${encuesta1QCounts[zona].C} (${totalEntries > 0 ? ((encuesta1QCounts[zona].C / totalEntries) * 100).toFixed(2) : 0}%)`,
                        `${encuesta1QCounts[zona].D} (${totalEntries > 0 ? ((encuesta1QCounts[zona].D / totalEntries) * 100).toFixed(2) : 0}%)`,
                        `${encuesta1QCounts[zona].E} (${totalEntries > 0 ? ((encuesta1QCounts[zona].E / totalEntries) * 100).toFixed(2) : 0}%)`,
                    ]);
                });
                analysisData.push([]);
                
                analysisData.push(["Análisis de Riesgo por Puesto de Trabajo"]);
                const puestoRisk = {};
                const puestoSet = new Set(allEntries.map(r => normalizeString(r.asociadoData?.puesto)));
                puestoSet.forEach(puesto => puestoRisk[puesto] = { total: 0, highRisk: 0 });
                allEntries.forEach(entry => {
                    const puesto = normalizeString(entry.asociadoData?.puesto);
                    const risk = entry.riskLevel || 'N/A';
                    if (puestoRisk[puesto]) {
                        puestoRisk[puesto].total++;
                        if (risk === 'Nivel de riesgo: ALTO') {
                            puestoRisk[puesto].highRisk++;
                        }
                    }
                });
                const puestoNombres = Object.keys(puestoRisk).sort();
                analysisData.push(["Puesto", "Total Asociados", "Riesgo Alto", "% Riesgo Alto"]);
                puestoNombres.forEach(puesto => {
                    const highRiskCount = puestoRisk[puesto].highRisk;
                    const totalCount = puestoRisk[puesto].total;
                    const highRiskPercentage = totalCount > 0 ? ((highRiskCount / totalCount) * 100).toFixed(2) : 0;
                    analysisData.push([puesto, totalCount, highRiskCount, `${highRiskPercentage}%`]);
                });
                analysisData.push([]);
                
                analysisData.push(["Análisis de Riesgo por Área de Trabajo"]);
                const areaRisk = {};
                const areaSet = new Set(allEntries.map(r => normalizeString(r.asociadoData?.area)));
                areaSet.forEach(area => areaRisk[area] = { total: 0, low: 0, medium: 0, high: 0 });
                allEntries.forEach(entry => {
                    const area = normalizeString(entry.asociadoData?.area);
                    const risk = entry.riskLevel || 'N/A';
                    if (areaRisk[area]) {
                        areaRisk[area].total++;
                        if (risk === 'Nivel de riesgo: BAJO') {
                            areaRisk[area].low++;
                        } else if (risk === 'Nivel de riesgo: MEDIO') {
                            areaRisk[area].medium++;
                        } else if (risk === 'Nivel de riesgo: ALTO') {
                            areaRisk[area].high++;
                        }
                    }
                });

                const areaNombres = Object.keys(areaRisk).sort();
                const areaRiskHeaders = ["Área", "Total Asociados", "Riesgo Bajo (%)", "Riesgo Medio (%)", "Riesgo Alto (%)"];
                analysisData.push(areaRiskHeaders);
                areaNombres.forEach(area => {
                    const total = areaRisk[area].total;
                    const lowPercent = total > 0 ? ((areaRisk[area].low / total) * 100).toFixed(2) : 0;
                    const mediumPercent = total > 0 ? ((areaRisk[area].medium / total) * 100).toFixed(2) : 0;
                    const highPercent = total > 0 ? ((areaRisk[area].high / total) * 100).toFixed(2) : 0;
                    analysisData.push([
                        area,
                        total,
                        `${lowPercent}%`,
                        `${mediumPercent}%`,
                        `${highPercent}%`
                    ]);
                });
                analysisData.push([]);

                analysisData.push(["Análisis de la Encuesta 2 (Riesgo por Bipedestación)"]);
                const encuesta2Apartados = {
                    'bipedestacion': 'Tiempo que la persona trabajadora permanece de pie',
                    'postura': 'Posibilidad de cambiar de postura',
                    'superficie': 'Tipo de superficie de trabajo',
                    'calzado': 'Características del calzado utilizado',
                    'espacio': 'Espacio disponible para moverse',
                    'malestares': 'Malestares reportados por la persona trabajadora',
                    'pausas': 'Pausas, tareas alternas o complementarias'
                };
                const encuesta2Options = {
                    bipedestacion: { "1": "≤ 30 minutos", "2": "> 30 min y ≤ 1 hora", "3": "> 1 hora" },
                    postura: { "1": "Sí, con frecuencia", "2": "Algunas veces", "3": "No puede cambiar" },
                    superficie: { "1": "Piso blando", "2": "Piso firme", "3": "Piso duro" },
                    calzado: { "1": "Ergonómico", "2": "Aceptable", "3": "Inadecuado" },
                    espacio: { "1": "Amplio", "2": "Limitado", "3": "Muy reducido" },
                    malestares: { "1": "Ninguno", "2": "Fatiga/dolor ocasional", "3": "Dolor/hinchazón frecuente" },
                    pausas: { "1": "Pausas planeadas", "2": "Pausas no programadas", "3": "No tiene pausas" }
                };

                const apartadosCounts = {};
                encuesta2Questions.forEach(qName => {
                    apartadosCounts[qName] = { '1': 0, '2': 0, '3': 0 };
                });

                allEntries.forEach(entry => {
                    encuesta2Questions.forEach(qName => {
                        const selection = entry.encuesta2Selections?.[qName]?.toString() || 'N/A';
                        if (apartadosCounts[qName][selection] !== undefined) {
                            apartadosCounts[qName][selection]++;
                        }
                    });
                });

                encuesta2Questions.forEach(qName => {
                    const apartadoTitle = encuesta2Apartados[qName];
                    analysisData.push([`Pregunta: ${apartadoTitle}`]);
                    
                    const opciones = encuesta2Options[qName];
                    for (const key in opciones) {
                        const count = apartadosCounts[qName][key] || 0;
                        const percentage = totalEntries > 0 ? ((count / totalEntries) * 100).toFixed(2) : 0;
                        analysisData.push([`Puntos ${key} (${opciones[key]})`, `${count} (${percentage}%)`]);
                    }
                });

                const wb = XLSX.utils.book_new();
                const ws1 = XLSX.utils.aoa_to_sheet(registrosData);
                const ws2 = XLSX.utils.aoa_to_sheet(analysisData);

                XLSX.utils.book_append_sheet(wb, ws1, "Registros");
                XLSX.utils.book_append_sheet(wb, ws2, "Análisis");

                XLSX.writeFile(wb, `registros_encuestas_${new Date().toISOString().slice(0,10)}.xlsx`);
                showMessage("Datos exportados exitosamente a Excel.");
            });
        }
        
        displaySavedRecords();

    });
    
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('Service Worker registrado con éxito:', registration);
                })
                .catch(error => {
                    console.error('Fallo el registro de Service Worker:', error);
                });
        });
    }
</script>
</body>
</html>